<template>
    <div class="svg-wrapper position-relative" style="padding-top:150px;">
      
      <!-- Pompon -->
      <div v-if="showPompon" class="pompon" style="position:absolute; top:60px; transform: scale(3)">
        <HatPompon :config="config" />
      </div>
  
      <!-- Główny SVG -->
      <svg 
        id="Warstwa_1_Obrazek_2" 
        ref="svgRef"
        data-name="Warstwa 1" 
        xmlns="http://www.w3.org/2000/svg"
        xmlns:xlink="http://www.w3.org/1999/xlink" 
        viewBox="0 0 595.42 552.52"
      >
        <clipPath id="clippath3">
          <path class="cls-2-2"
            d="M594.86,462.47c-.39-11.35-.86-22.77-1.67-34.24-1.21-17.15-.16-34.61.36-52.22.25-8.31.38-16.65.63-25.04.15-4.85-.66-9.52-2.52-13.98-2.18-5.2-5.86-8.54-13.07-8.07-.24.02-.47.02-.71.03-.83-6.52-2.13-13.06-2.27-15.2,1.52-11.51-20.86-149.01-20.86-149.01,0,0-.41-1.07-1.07-2.79-.33-.86-.72-1.87-1.15-3-.22-.56-.44-1.15-.68-1.76-.23-.61-.48-1.24-.72-1.88-.25-.64-.5-1.3-.75-1.96-.25-.66-.51-1.33-.77-2-.26-.67-.51-1.34-.77-2-.25-.66-.51-1.32-.75-1.96-.25-.64-.49-1.27-.72-1.88-.23-.61-.46-1.2-.68-1.77-.43-1.13-.82-2.15-1.15-3.01-.66-1.72-1.07-2.8-1.07-2.8h0c-.26-1.05-.49-1.97-.88-2.83-.41-.91-.82-1.83-1.24-2.74-.42-.91-.83-1.83-1.25-2.74-.42-.91-.84-1.83-1.26-2.75-.42-.92-.84-1.83-1.26-2.75-.42-.92-.84-1.84-1.27-2.76-.42-.92-.85-1.84-1.27-2.76-.42-.92-.84-1.84-1.27-2.77-.42-.92-.84-1.85-1.26-2.77-.39-.87-.78-1.74-1.17-2.6-.39-.87-.78-1.74-1.17-2.61-.39-.87-.78-1.74-1.16-2.61-.39-.87-.77-1.74-1.16-2.61-.39-.87-.77-1.74-1.16-2.61-.39-.87-.77-1.74-1.16-2.61-.31-.51-.63-1.03-.95-1.53-.32-.51-.64-1.02-.96-1.52-.65-1.01-1.3-2.01-1.97-2.99-.67-.99-1.35-1.97-2.03-2.93-20-28.15-48.36-48.09-81.15-61.27-9.06-3.64-18.45-6.77-28.05-9.51C312.59-10.36,193.08-8.69,109.37,49.49c-15.08,12.26-27.59,26.11-38.02,40.9-1.3,1.85-2.57,3.71-3.81,5.58-1.24,1.87-2.44,3.76-3.62,5.66-1.17,1.9-2.32,3.81-3.43,5.73-1.11,1.92-2.2,3.85-3.25,5.79-1.06,1.94-2.08,3.89-3.08,5.85-1,1.96-1.97,3.92-2.91,5.9-.34.71-.65,1.43-.93,2.16-.29.73-.55,1.47-.81,2.23-.42.57-.8,1.15-1.12,1.75-.33.6-.61,1.22-.84,1.86-5.13,14.29-8.21,24.31-10.08,31.22,0,0-11.35,130.92-14.06,149.95,0,6.66-1.6,14.53-2.94,19.92-1.96.04-3.92.06-5.89,0-7.19-.22-10.7,3.25-12.62,8.52-1.64,4.51-2.22,9.2-1.84,14.05.65,8.37,1.18,16.7,1.82,24.99,1.36,17.58,3.22,34.98,2.84,52.15-.26,11.48-.19,22.91-.04,34.26.14,10.67.35,21.27.99,31.82.36,5.93,2.4,11.63,8.11,16.1,6.93,4.86,14.55,8.78,22.19,12.66,7.46,3.79,15.59,6,23.57,8.62,15.36,5.04,31.18,6.82,47.15,8.03,13.82,1.05,27.64,2.12,41.44,3.23,8.22.66,16.42,1.48,24.63,2.11,8.12.63,16.19.34,24.16-.77,2.4-.33,4.7-1.15,7.77-1.93,8.77,3.02,18.85,3.14,28.85,3.39,2.96.07,6.17-.57,8.85-1.61,3.43-1.33,6.46-.77,9.66.16,1.19.35,2.29.92,3.5,1.17,2.95.62,5.96,1.62,8.91,1.58,8.46-.13,17.01.05,25.08-2.8,3.63-1.28,7.39-.27,11.11.27,8.73,1.27,17.58,1.61,26.04-.77,4.37-1.22,8.23-1.35,12.75-.98,7.72.62,15.61.35,23.41-.05,3.36-.17,6.63-1.63,9.97-2.43.99-.24,2.16-.48,3.1-.28,7.96,1.64,15.95,2.98,24.19,3.42,5.02.27,8.98-.14,13.48-2.28,8.73,3.93,18.54,3.5,28.3,3.28,1.1-.02,2.32-.14,3.28-.55.91-.39,1.84-.71,2.77-.97,2.3-.28,4.61-.55,6.91-.81.94-.11,1.89-.21,2.83-.32,1.72-.02,3.45,0,5.17,0,.10-.20.19-.40.28-.61,11.01-1.23,22.03-2.45,33.06-3.64,15.94-1.73,31.72-4.02,46.88-9.56,7.88-2.88,15.93-5.35,23.23-9.38,7.48-4.13,14.95-8.3,21.66-13.38,5.51-4.65,7.3-10.42,7.37-16.36.13-10.56-.17-21.17-.53-31.84Z" />
        </clipPath>

   
        <clipPath id="maska-srodek">
          <path d="M949.65,276.98c-419.64,77.74-849.69,83.84-1271.39,18.27,9.1-62.56,18.27-125.1,27.52-187.64,400.34,63.69,808.73,59.36,1207.59-13,12.02,60.8,24.11,121.59,36.28,182.37Z" />
        </clipPath>

        
        <clipPath id="dolnamaskaprawa" transform="translate(0, -400)">
          <path class="cls-2-2"
            d="M594.86,462.47c-.39-11.35-.86-22.77-1.67-34.24-1.21-17.15-.16-34.61.36-52.22.25-8.31.38-16.65.63-25.04.15-4.85-.66-9.52-2.52-13.98-2.18-5.2-5.86-8.54-13.07-8.07-.24.02-.47.02-.71.03-.83-6.52-2.13-13.06-2.27-15.2,1.52-11.51-20.86-149.01-20.86-149.01,0,0-.41-1.07-1.07-2.79-.33-.86-.72-1.87-1.15-3-.22-.56-.44-1.15-.68-1.76-.23-.61-.48-1.24-.72-1.88-.25-.64-.5-1.3-.75-1.96-.25-.66-.51-1.33-.77-2-.26-.67-.51-1.34-.77-2-.25-.66-.51-1.32-.75-1.96-.25-.64-.49-1.27-.72-1.88-.23-.61-.46-1.2-.68-1.77-.43-1.13-.82-2.15-1.15-3.01-.66-1.72-1.07-2.8-1.07-2.8h0c-.26-1.05-.49-1.97-.88-2.83-.41-.91-.82-1.83-1.24-2.74-.42-.91-.83-1.83-1.25-2.74-.42-.91-.84-1.83-1.26-2.75-.42-.92-.84-1.83-1.26-2.75-.42-.92-.84-1.84-1.27-2.76-.42-.92-.85-1.84-1.27-2.76-.42-.92-.84-1.84-1.27-2.77-.42-.92-.84-1.85-1.26-2.77-.39-.87-.78-1.74-1.17-2.6-.39-.87-.78-1.74-1.17-2.61-.39-.87-.78-1.74-1.16-2.61-.39-.87-.77-1.74-1.16-2.61-.39-.87-.77-1.74-1.16-2.61-.39-.87-.77-1.74-1.16-2.61-.31-.51-.63-1.03-.95-1.53-.32-.51-.64-1.02-.96-1.52-.65-1.01-1.3-2.01-1.97-2.99-.67-.99-1.35-1.97-2.03-2.93-20-28.15-48.36-48.09-81.15-61.27-9.06-3.64-18.45-6.77-28.05-9.51C312.59-10.36,193.08-8.69,109.37,49.49c-15.08,12.26-27.59,26.11-38.02,40.9-1.3,1.85-2.57,3.71-3.81,5.58-1.24,1.87-2.44,3.76-3.62,5.66-1.17,1.9-2.32,3.81-3.43,5.73-1.11,1.92-2.2,3.85-3.25,5.79-1.06,1.94-2.08,3.89-3.08,5.85-1,1.96-1.97,3.92-2.91,5.9-.34.71-.65,1.43-.93,2.16-.29.73-.55,1.47-.81,2.23-.42.57-.8,1.15-1.12,1.75-.33.6-.61,1.22-.84,1.86-5.13,14.29-8.21,24.31-10.08,31.22,0,0-11.35,130.92-14.06,149.95,0,6.66-1.6,14.53-2.94,19.92-1.96.04-3.92.06-5.89,0-7.19-.22-10.7,3.25-12.62,8.52-1.64,4.51-2.22,9.2-1.84,14.05.65,8.37,1.18,16.7,1.82,24.99,1.36,17.58,3.22,34.98,2.84,52.15-.26,11.48-.19,22.91-.04,34.26.14,10.67.35,21.27.99,31.82.36,5.93,2.4,11.63,8.11,16.1,6.93,4.86,14.55,8.78,22.19,12.66,7.46,3.79,15.59,6,23.57,8.62,15.36,5.04,31.18,6.82,47.15,8.03,13.82,1.05,27.64,2.12,41.44,3.23,8.22.66,16.42,1.48,24.63,2.11,8.12.63,16.19.34,24.16-.77,2.4-.33,4.7-1.15,7.77-1.93,8.77,3.02,18.85,3.14,28.85,3.39,2.96.07,6.17-.57,8.85-1.61,3.43-1.33,6.46-.77,9.66.16,1.19.35,2.29.92,3.5,1.17,2.95.62,5.96,1.62,8.91,1.58,8.46-.13,17.01.05,25.08-2.8,3.63-1.28,7.39-.27,11.11.27,8.73,1.27,17.58,1.61,26.04-.77,4.37-1.22,8.23-1.35,12.75-.98,7.72.62,15.61.35,23.41-.05,3.36-.17,6.63-1.63,9.97-2.43.99-.24,2.16-.48,3.1-.28,7.96,1.64,15.95,2.98,24.19,3.42,5.02.27,8.98-.14,13.48-2.28,8.73,3.93,18.54,3.5,28.3,3.28,1.10-.02,2.32-.14,3.28-.55.91-.39,1.84-.71,2.77-.97,2.3-.28,4.61-.55,6.91-.81.94-.11,1.89-.21,2.83-.32,1.72-.02,3.45,0,5.17,0,.10-.20.19-.40.28-.61,11.01-1.23,22.03-2.45,33.06-3.64,15.94-1.73,31.72-4.02,46.88-9.56,7.88-2.88,15.93-5.35,23.23-9.38,7.48-4.13,14.95-8.3,21.66-13.38,5.51-4.65,7.3-10.42,7.37-16.36.13-10.56-.17-21.17-.53-31.84Z" /> 
        </clipPath>
        
        <path id="textCurve" d="M 50 268 Q 300 284 556 265" fill="none" stroke="none" />
  
        <g class="cls-4-2">
          <g>
            <g>
              <path class="cls-5-2" :fill="config.base.bottom"
                d="M990.68,480.29c-442.79,83.82-897,91.95-1342.54,24.35,15.38-107.98,31-215.94,46.85-323.85,408.67,64.43,825.51,59.42,1232.48-15.03,20.84,104.89,41.92,209.73,63.22,314.53Z" />
              <g>
                <path class="cls-3-2" :fill="config.base.top"
                  d="M913.38,94.62c-398.87,72.36-807.26,76.68-1207.59,13,8.48-57.28,17.03-114.56,25.64-171.82C112.19-2.3,500.74-5.05,880.57-72.52c10.87,55.73,21.81,111.44,32.81,167.14Z" />
                <path class="cls-1-2" :fill="config.base.middle"
                  d="M949.65,276.98c-419.64,77.74-849.69,83.84-1271.39,18.27,9.1-62.56,18.27-125.1,27.52-187.64,400.34,63.69,808.73,59.36,1207.59-13,12.02,60.8,24.11,121.59,36.28,182.37Z" />
                <path class="cls-2-2"
                  d="M975.89,407.36c-434.48,81.63-880.03,89.03-1317.01,22.15,23.63-164.65,47.81-329.22,72.54-493.72C112.19-2.3,500.74-5.05,880.57-72.52c31.23,160.07,63.01,320.03,95.32,479.88Z" />
              </g>
            </g>
            
            <!-- Paski (stripes) - SKRÓCONA WERSJA, dodaj wszystkie! -->
           <g>
            <g>
              <g>
                <path class="pasek"
                  d="M-.19,544.04c-1.34-.1-2-.15-3.34-.25C.24,474.21,4.02,404.63,7.8,335.04c1.27.1,1.91.15,3.18.24C7.26,404.87,3.53,474.45-.19,544.04Z" />
                <path class="pasek"
                  d="M34.55,546.4c-1.34-.08-2-.13-3.34-.21,3.23-69.58,6.46-139.17,9.7-208.75,1.27.09,1.91.13,3.18.21-3.18,69.58-6.36,139.17-9.54,208.75Z" />
                <path class="pasek"
                  d="M69.31,548.42c-1.34-.07-2.01-.11-3.34-.18,2.68-69.58,5.37-139.16,8.05-208.74,1.27.07,1.91.11,3.18.18-2.63,69.58-5.26,139.16-7.9,208.74Z" />
              </g>
              <g>
                <path class="pasek"
                  d="M103.62,550.05c-1.34-.06-2.01-.09-3.34-.14,2.14-69.57,4.29-139.15,6.44-208.72,1.27.06,1.91.09,3.19.15-2.09,69.57-4.19,139.14-6.28,208.72Z" />
                <path class="pasek"
                  d="M138.39,551.36c-1.34-.04-2.01-.07-3.34-.11,1.6-69.56,3.2-139.12,4.8-208.68,1.27.05,1.91.07,3.19.11-1.55,69.56-3.09,139.12-4.64,208.67Z" />
                <path class="pasek"
                  d="M173.16,552.3c-1.34-.03-2.01-.04-3.34-.08,1.05-69.54,2.11-139.08,3.16-208.62,1.27.03,1.91.05,3.19.08-1,69.54-2,139.08-3,208.61Z" />
                <path class="pasek"
                  d="M207.94,552.9c-1.34-.02-2.01-.02-3.34-.04.51-69.52,1.01-139.03,1.52-208.55,1.27.02,1.91.03,3.19.05-.45,69.51-.91,139.02-1.36,208.54Z" />
                <path class="pasek"
                  d="M242.71,553.13c-1.34,0-2.01,0-3.34,0-.04-69.48-.08-138.97-.12-208.45,1.27,0,1.91.01,3.19.02.09,69.48.18,138.96.27,208.44Z" />

                <path class="pasek"
                  d="M277.48,553.01c-1.34.01-2.01.02-3.34.03-.58-69.45-1.17-138.9-1.75-208.34,1.27,0,1.91,0,3.19-.02.64,69.44,1.27,138.89,1.91,208.33Z" />
                <path class="pasek"
                  d="M315.81,552.47c-1.34.03-2.01.04-3.34.06-1.18-69.4-2.37-138.8-3.55-208.21,1.27-.02,1.91-.03,3.19-.05,1.24,69.4,2.47,138.79,3.71,208.19Z" />
                <path class="pasek"
                  d="M350.57,551.6c-1.34.04-2.01.06-3.34.1-1.73-69.35-3.46-138.71-5.18-208.06,1.27-.03,1.91-.05,3.18-.08,1.78,69.35,3.56,138.7,5.34,208.05Z" />
                <path class="pasek"
                  d="M385.32,550.37c-1.34.05-2,.08-3.34.13-2.27-69.3-4.54-138.6-6.81-207.9,1.27-.05,1.91-.07,3.18-.12,2.32,69.29,4.65,138.59,6.97,207.88Z" />
                <path class="pasek"
                  d="M420.05,548.79c-1.34.07-2,.1-3.34.17-2.81-69.24-5.63-138.48-8.44-207.72,1.27-.06,1.91-.09,3.18-.15,2.87,69.24,5.73,138.47,8.6,207.71Z" />
                <path class="pasek"
                  d="M454.78,546.86c-1.34.08-2,.12-3.34.2-3.36-69.18-6.71-138.35-10.07-207.53,1.27-.07,1.91-.11,3.18-.18,3.41,69.17,6.82,138.34,10.23,207.51Z" />
                <path class="pasek"
                  d="M489.49,544.57c-1.33.09-2,.14-3.34.24-3.9-69.11-7.8-138.21-11.7-207.32,1.27-.09,1.91-.13,3.18-.21,3.95,69.1,7.9,138.2,11.85,207.3Z" />
              </g>
              <g>
                <path class="pasek"
                  d="M525.73,541.79c-1.33.11-2,.16-3.33.27-4.46-69.03-8.93-138.05-13.39-207.08,1.27-.1,1.91-.15,3.18-.25,4.52,69.02,9.03,138.04,13.55,207.06Z" />
                <path class="pasek"
                  d="M560.4,538.77c-1.33.12-2,.18-3.33.31-5-68.95-10.01-137.89-15.01-206.84,1.27-.11,1.91-.17,3.18-.28,5.06,68.94,10.11,137.88,15.17,206.81Z" />
                <path class="pasek"
                  d="M595.05,535.4c-1.33.14-2,.2-3.33.34-5.54-68.86-11.09-137.72-16.63-206.58,1.27-.12,1.91-.19,3.18-.31,5.6,68.85,11.19,137.7,16.79,206.55Z" />
              </g>
            </g>
           </g>
          </g>
        </g>
  
        <defs>
          <path id="curvePath" d="M -53 269 Q 297 300 650 265" />
        </defs>
        
        <!-- Wzór górny -->
        <g class="dolnamaska" :fill="config.pattern.top">
          <g class="fls-4">
            <g transform="translate(-260, 0)" id="target-wzor">
              <g v-html="topPatternSvg"></g> 
            </g>
          </g>
        </g>
        
        <!-- Główny wzór -->
        <g clip-path="url(#clippath3)" :fill="config.pattern.main">
          <g transform="translate(-180, 152.3) scale(0.872)" id="target-graphic">
            <g v-html="mainPatternSvg"></g>
          </g>
        </g>
  
        <!-- Tekst na krzywej -->
         <g clip-path="url(#maska-srodek)">
        <g clip-path="url(#clippath3)">
          <text 
            :dy="finalTextPosition"
            :font-family="config.text.font" 
            font-weight="bold" 
            :font-size="config.text.fontSize" 
            :fill="config.text.color"
            text-anchor="middle" 
            letter-spacing="2"
          >
            <textPath 
              xlink:href="#curvePath" 
              startOffset="50%" 
              method="align" 
              spacing="auto"
            >
              {{ config.text.content }}
            </textPath>
          </text>
        </g>
        </g>
      </svg>
    </div>
  </template>
<script setup>
import { ref, computed, watch, nextTick } from 'vue';
import { bendIt, resetWarp } from '../../utils/warpTransform.js';
import HatPompon from './HatPompon.vue';

const props = defineProps({
  config: {
    type: Object,
    required: true
  },
  showPompon: {
    type: Boolean,
    default: true
  },
  patternsDict: {
    type: Array,
    default: () => []
  }
});

const svgRef = ref(null);

const topPatternSvg = computed(() => {
  const selectedId = props.config.patterns.top;
  if (!selectedId || selectedId === 'none') return '';
  const pattern = props.patternsDict.find(p => p.id === selectedId);
  return pattern ? pattern.kodSvg : '';
});

const mainPatternSvg = computed(() => {
  const selectedId = props.config.patterns.bottom;
  if (!selectedId || selectedId === 'none') return '';
  const pattern = props.patternsDict.find(p => p.id === selectedId);
  return pattern ? pattern.kodSvg : '';
});

// HatFront.vue / HatThumbnail.vue

const finalTextPosition = computed(() => {
  const fontSize = props.config.text.fontSize;
  
  let stala;
  
  if(fontSize >= 100){
    stala = 0.34;
  }
  else if(fontSize >= 50 && fontSize < 100){
    stala = 0.33;
  }
  else{
    stala = 0.20;
  }
  const coefficient = stala + (100 - fontSize) * 0.0001;
  const baseOffset = (fontSize * coefficient) - 33;
  const manualOffset = (props.config.text.offsetY || 0) * 1.15;
  
  return baseOffset + manualOffset;
});
// Funkcja dla górnego wzoru
const applyTopWarp = async () => {
  await nextTick();
  setTimeout(() => {
    if (svgRef.value) {
      resetWarp('#target-wzor');
      bendIt(svgRef.value, '#target-wzor', 570, -0.0001);
    }
  }, 100);
};

// Funkcja dla dolnego wzoru
const applyBottomWarp = async () => {
  await nextTick();
  setTimeout(() => {
    if (svgRef.value) {
      resetWarp('#target-graphic');
      bendIt(svgRef.value, '#target-graphic', 510, -0.00013);
    }
  }, 100);
};

watch(
  () => topPatternSvg.value,
  (newValue) => {
    if (newValue) {
      applyTopWarp();
    }
  },
  { immediate: true }
);

// ⭐ Osobny watch dla dolnego wzoru
watch(
  () => mainPatternSvg.value,
  (newValue) => {
    if (newValue) {
      applyBottomWarp();
    }
  },
  { immediate: true }
);
</script>
  
  <style scoped>
  .dolnamaska {
    clip-path: url(#dolnamaskaprawa);
  }
  
  .fls-4 {
    clip-path: url(#clippath3);  
  }
  
  .pasek {
    fill: var(--kolor-pasek);
  }
  
  .cls-2-2 {
    fill: none;
  }
  
  .cls-4-2 {
    clip-path: url(#clippath3);
  }
  </style>